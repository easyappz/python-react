name: Deploy to K3s with GHCR

on:
  push:
    branches:
      - 'app-*'  # app-1, app-2, ..., app-100

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/myapp  # –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑—å–º–µ—Ç –≤–∞—à username

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ GHCR
    
    steps:
      # ========================================
      # –®–ê–ì 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # –®–ê–ì 2: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å APP_ID
      # ========================================
      - name: Extract App ID
        id: vars
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          APP_ID="${BRANCH_NAME#app-}"
          
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "image_full=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${APP_ID}:latest" >> $GITHUB_OUTPUT
          echo "image_sha=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${APP_ID}:${{ github.sha }}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ App ID: $APP_ID"
          echo "‚úÖ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${APP_ID}:latest"

      # ========================================
      # –®–ê–ì 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Buildx
      # ========================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ========================================
      # –®–ê–ì 4: –õ–æ–≥–∏–Ω –≤ GitHub Container Registry
      # ========================================
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      # ========================================
      # –®–ê–ì 5: –°–æ–±—Ä–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–∑ –≤ GHCR
      # ========================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: |
            APP_ID=${{ steps.vars.outputs.app_id }}
          tags: |
            ${{ steps.vars.outputs.image_full }}
            ${{ steps.vars.outputs.image_sha }}
          cache-from: type=registry,ref=${{ steps.vars.outputs.image_full }}
          cache-to: type=inline

      # ========================================
      # –®–ê–ì 6: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å kubectl
      # ========================================
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
          kubectl version --client
          kubectl cluster-info

      # ========================================
      # –®–ê–ì 7: –°–æ–∑–¥–∞—Ç—å namespace
      # ========================================
      - name: Create namespace
        run: |
          kubectl create namespace apps --dry-run=client -o yaml | kubectl apply -f -

      # ========================================
      # –®–ê–ì 8: –°–æ–∑–¥–∞—Ç—å Secret –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ GHCR
      # ========================================
      - name: Create image pull secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ secrets.GHCR_USERNAME }} \
            --docker-password=${{ secrets.GHCR_TOKEN }} \
            --namespace=apps \
            --dry-run=client -o yaml | kubectl apply -f -

      # ========================================
      # –®–ê–ì 9: –ü—Ä–∏–º–µ–Ω–∏—Ç—å Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
      # ========================================
      - name: Deploy to K3s
        run: |
          APP_ID=${{ steps.vars.outputs.app_id }}
          IMAGE=${{ steps.vars.outputs.image_full }}
          
          cat <<EOF | kubectl apply -f -
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: app-${APP_ID}
            namespace: apps
            labels:
              app: app-${APP_ID}
              version: "${{ github.sha }}"
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: app-${APP_ID}
            template:
              metadata:
                labels:
                  app: app-${APP_ID}
              spec:
                imagePullSecrets:
                - name: ghcr-secret
                containers:
                - name: app
                  image: ${IMAGE}
                  imagePullPolicy: Always
                  ports:
                  - containerPort: 8080
                    name: http
                  env:
                  - name: APP_ID
                    value: "${APP_ID}"
                  - name: DJANGO_SUPERUSER_USERNAME
                    value: "admin"
                  - name: DJANGO_SUPERUSER_PASSWORD
                    value: "admin"
                  - name: DJANGO_SUPERUSER_EMAIL
                    value: "admin@mail.ru"
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 8080
                    initialDelaySeconds: 60
                    periodSeconds: 10
                    timeoutSeconds: 5
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 8080
                    initialDelaySeconds: 30
                    periodSeconds: 5
                    timeoutSeconds: 3
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: app-${APP_ID}-service
            namespace: apps
            labels:
              app: app-${APP_ID}
          spec:
            type: ClusterIP
            ports:
            - port: 8080
              targetPort: 8080
              protocol: TCP
              name: http
            selector:
              app: app-${APP_ID}
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: app-${APP_ID}-ingress
            namespace: apps
            annotations:
              kubernetes.io/ingress.class: traefik
              traefik.ingress.kubernetes.io/router.entrypoints: web
          spec:
            rules:
            - host: app-${APP_ID}.yourdomain.com
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: app-${APP_ID}-service
                      port:
                        number: 8080
          EOF

      # ========================================
      # –®–ê–ì 10: –î–æ–∂–¥–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
      # ========================================
      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/app-${{ steps.vars.outputs.app_id }} \
            -n apps --timeout=5m

      # ========================================
      # –®–ê–ì 11: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
      # ========================================
      - name: Verify deployment
        run: |
          APP_ID=${{ steps.vars.outputs.app_id }}
          
          echo "================================"
          echo "üì¶ PODS STATUS:"
          echo "================================"
          kubectl get pods -n apps -l app=app-${APP_ID} -o wide
          
          echo ""
          echo "================================"
          echo "üåê SERVICE:"
          echo "================================"
          kubectl get svc -n apps app-${APP_ID}-service
          
          echo ""
          echo "================================"
          echo "üîó INGRESS:"
          echo "================================"
          kubectl get ingress -n apps app-${APP_ID}-ingress
          
          echo ""
          echo "================================"
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo "================================"
          echo "App URL: http://app-${APP_ID}.yourdomain.com"
          echo "Image: ${{ steps.vars.outputs.image_full }}"
          echo "Commit: ${{ github.sha }}"