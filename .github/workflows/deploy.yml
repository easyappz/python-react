name: Build and Deploy to K3s

on:
  push:
    branches:
      - 'app-*'
  workflow_dispatch:
    inputs:
      app_id:
        description: 'Application ID'
        required: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract App ID
        id: app
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            APP_ID="${{ github.event.inputs.app_id }}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
            APP_ID=${BRANCH#app-}
          fi
          echo "id=${APP_ID}" >> $GITHUB_OUTPUT
          echo "version=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "build=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT
          
          echo "üì¶ Deploying app-${APP_ID}"
      
      # ===================================
      # Docker Build
      # ===================================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./app          # ‚Üê –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ - –ø–∞–ø–∫–∞ app/
          file: ./app/Dockerfile  # ‚Üê –ü—É—Ç—å –∫ Dockerfile
          push: true
          build-args: |
            APP_ID=${{ steps.app.outputs.id }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:app-${{ steps.app.outputs.id }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:app-${{ steps.app.outputs.id }}-${{ steps.app.outputs.build }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # ===================================
      # K8s Deployment
      # ===================================
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Prepare K8s manifests
        env:
          APP_ID: ${{ steps.app.outputs.id }}
          IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:app-${{ steps.app.outputs.id }}
          VERSION: ${{ steps.app.outputs.version }}
          BUILD_NUMBER: ${{ steps.app.outputs.build }}
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          mkdir -p /tmp/k8s-manifests
          
          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ YAML —Ñ–∞–π–ª—ã –∏–∑ k8s/
          for file in k8s/*.yaml; do
            if [ -f "$file" ]; then
              echo "Processing: $file"
              sed -e "s|{{APP_ID}}|${APP_ID}|g" \
                  -e "s|{{IMAGE}}|${IMAGE}|g" \
                  -e "s|{{VERSION}}|${VERSION}|g" \
                  -e "s|{{BUILD_NUMBER}}|${BUILD_NUMBER}|g" \
                  "$file" > "/tmp/k8s-manifests/$(basename $file)"
            fi
          done
          
          echo "‚úÖ Manifests prepared:"
          ls -la /tmp/k8s-manifests/
      
      - name: Deploy to K3s
        run: |
          APP_ID=${{ steps.app.outputs.id }}
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
          echo "üì¶ Creating namespace..."
          kubectl apply -f /tmp/k8s-manifests/namespace.yaml
          
          echo "üîê Creating secrets..."
          kubectl apply -f /tmp/k8s-manifests/secret.yaml 2>/dev/null || echo "No secrets file"
          
          echo "‚öôÔ∏è  Creating configmap..."
          kubectl apply -f /tmp/k8s-manifests/configmap.yaml 2>/dev/null || echo "No configmap file"
          
          echo "üöÄ Deploying application..."
          kubectl apply -f /tmp/k8s-manifests/deployment.yaml
          
          echo "üåê Creating service..."
          kubectl apply -f /tmp/k8s-manifests/service.yaml
          
          echo "üîå Creating ingress..."
          kubectl apply -f /tmp/k8s-manifests/ingress.yaml
          
          echo "üìä Setting up autoscaling..."
          kubectl apply -f /tmp/k8s-manifests/hpa.yaml 2>/dev/null || echo "No HPA file"
      
      - name: Wait for deployment
        run: |
          APP_ID=${{ steps.app.outputs.id }}
          echo "‚è≥ Waiting for deployment..."
          
          kubectl wait --for=condition=available --timeout=300s \
            deployment/app-${APP_ID} -n app-${APP_ID} || {
              echo "‚ùå Deployment failed! Getting logs..."
              kubectl logs -n app-${APP_ID} -l app=app-${APP_ID} --tail=100
              kubectl describe pod -n app-${APP_ID} -l app=app-${APP_ID}
              exit 1
            }
          
          echo "‚úÖ Deployment successful!"
      
      - name: Show deployment info
        run: |
          APP_ID=${{ steps.app.outputs.id }}
          
          echo "========================================="
          echo "üéâ Deployment Complete!"
          echo "========================================="
          echo "App ID: app-${APP_ID}"
          echo "Namespace: app-${APP_ID}"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:app-${APP_ID}"
          echo ""
          
          echo "üì¶ Pods:"
          kubectl get pods -n app-${APP_ID} -o wide
          echo ""
          
          echo "üåê Services:"
          kubectl get svc -n app-${APP_ID}
          echo ""
          
          echo "üîå Ingress:"
          kubectl get ingress -n app-${APP_ID}
          echo ""
          
          echo "========================================="
          echo "üåç Access URL: http://app-${APP_ID}.yourdomain.com"
          echo "========================================="